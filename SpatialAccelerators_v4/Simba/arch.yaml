# Refer from test/v4_soter/simba_arch.yaml
architecture:
  version: 0.4
  nodes:
  - !Container
    name: System
    attributes:
      technology: "40nm"  
      global_cycle_seconds: 1e-9
      datawidth: 8

  - !Component
    name: DRAM
    class: DRAM
    attributes:
      # type: "LPDDR4"
      cluster_size: 1
      read_bandwidth: 1
      write_bandwidth: 1
      block_size: 64 # 匹配v2设定, 同时改动width
      datawidth: 8
      width: 512
      # 参考spatialAccelerators/simba/mapspace.yaml的配置补全约束:
      constraints:
        dataspace: {keep: [Inputs, Outputs, Weights], bypass: []}    

  - !Container
    name: Chip
    attributes:
      technology: "40nm"  

  - !Component
    name: GlobalBuffer
    class: SRAM
    attributes:
      block_size: 8
      cluster_size: 1
      depth: 8192
      num_banks: 256
      num_ports: 2
      read_bandwidth: 2
      width: 64
      datawidth: 8
      write_bandwidth: 2
      # 参考spatialAccelerators/simba/mapspace.yaml的配置补全约束:
      constraints:
        dataspace: {keep: [Inputs, Outputs], bypass: [Weights]}  

  - !Container
    name: PE
    spatial: {meshX: 16} 
  - !Parallel  
    nodes:
    - !Component
      name: InputBuffer  
      class: regfile  
      attributes:
        block_size: 4
        cluster_size: 1
        depth: 2048  
        width: 32
        num_banks: 1
        num_ports: 2
        read_bandwidth: 2
        write_bandwidth: 2
        datawidth: 8
      constraints:
        dataspace: {keep: [Inputs], bypass: [Weights, Outputs]}        
        # # TODO: 是否需要补充temporal约束？
        # # 参考exercise_06的eyeriss_like配置:
        # temporal:
        #   permutation: [N, K, C, P, Q, R, S] 
        #   factors: [N=1, K=1, C=1, P=1, Q=1, R=1, S=1]  # 完整传入

    - !Component
      name: WeightBuffer
      class: regfile  
      attributes:
        block_size: 4
        cluster_size: 1
        depth: 8192
        width: 32
        num_banks: 8
        num_ports: 1
        datawidth: 8
        read_bandwidth: 2
        write_bandwidth: 2
      constraints:
        dataspace: {keep: [Weights], bypass: [Inputs, Outputs]}        
        # TODO: 是否需要补充temporal约束？
        # # 参考exercise_06的eyeriss_like配置:
        # temporal:
        #   permutation: [N, K, P, Q, S, C, R]
        #   factors: [N=1, K=1, P=1, Q=1, S=1]

    - !Component
      name: AccumulationBuffer
      class: regfile  
      attributes:
        block_size: 4
        cluster_size: 1
        depth: 768
        network_word_bits: 16
        num_banks: 2
        num_ports: 2
        read_bandwidth: 2
        width: 96
        datawidth: 24
        write_bandwidth: 2
      constraints:
        dataspace: {keep: [Outputs], bypass: [Inputs, Weights]}        
        # TODO: 是否需要补充temporal约束？
        # temporal:
        #   permutation: [N, C, P, Q, R, S, K] 
        #   factors: [N=1, C=1, R=1, S=1, P=1, Q=1]

  # 引入reg_mac统一定义
  - !Container
    name: reg_mac
    spatial: {meshX: 64}  # meshX还是meshY?
  - !Component
    name: Registers
    class: regfile  
    attributes:
      block_size: 1
      cluster_size: 1
      depth: 1
      num_banks: 8
      num_ports: 2
      read_bandwidth: 2
      width: 8
      datawidth: 8
      write_bandwidth: 2
      # 参考spatialAccelerators/simba/mapspace.yaml的配置补全约束:
      constraints:
        dataspace: {keep: [Weights], bypass: [Outputs, Inputs]}  # FIXME: 寄存器只存权重？        

  - !Component
      name: MACC
      # spatial: {meshX: 64}  # meshX还是meshY?
      class: intmac  
      attributes:
        cluster_size: 1
        datawidth: 8
        multiplier_width: 8 # 乘数位宽 8 bit
        adder_width: 16 # 加法器位宽 16 bit
